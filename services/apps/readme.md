# Siemens showcase (afqp & websi) root module
Terraform root module to create websi and afqp resources for the Siemens Showcase.

## Description
This root module calls several child modules in the modules folder and deploys several resources required for websi and afqp application.

The following resources are created:

**3 resource groups:**
 - a resource group for the afqp backend resources.
 - a resource group for the websi backend resources.
 - and a resource group for the shared resources.

**For the afqp application stack:**
- 1 Storage account + corresponding private endpoint in the afqp backend resource group
- 1 Redis cache instance + corresponding private endpoint in the afqp backend resource group
- 1 App service + corresponding private endpoint in the shared resource group
- 1 App insights for monitoring the App service in the shared resource group

**For the websi application stack:**
- 1 Storage account + corresponding private endpoint
- 1 Redis cache instance + corresponding private endpoint in the afqp backend resource group
- 1 CosmosDB (mongoDB) + corresponding private endpoint in the afqp backend resource group
- 1 App service + corresponding private endpoint in the shared resource group
- 1 App insights for monitoring the App service in the shared resource group

**The shared resources in the shared resource group are:**
- 1 Application Gateway
- 1 Managed SQL Instance
- 1 App service plan
- 4 Azure Private DNS zones

### Naming convention module
To ensure & enforce the required naming convention, the helper terraform-naming module is used by all other child modules.
The names being generated by the naming module are the actual resource name which are used on the Azure platform.
There are quite a few instances of the naming module created in this root module to group resources together.

### Existing resources
The resources being deployed via Terraform modules, will be deployed in an existing environment (DCS Landingzone subscriptions).
Networking resources (virtual network & subnets) are already available prior to Terraform deployment.

Terraform Data sources blocks are used to access the existing network resource information needed to deploy the Terraform resources correctly.

### Root module overview
The root module has been configured as follows:
1. First the naming module instances are created.
2. The data blocks are defined next.
3. Following the data blocks, the resource groups are defined.
4. After the resource groups blocks, the Azure Private DNS zones are defined.
5. In the following section all the dedicated afqp application resources are defined.
6. In the following section all the dedicated websi application resources are defined.
7. And finally the shared resources (App Services resources, SQL Managed Instance & App Gateway) are defined.

### Root module prerequisites
The deployment of the application landscape for the Siemens Showcase is being provided via this root module.
There are a few prerequisites to be able to deploy successfully to an existing landingzone environment on the Azure platform.
These are primarly focused on existing virtual networks and subnets:
- Enable PrivateEndpointNetworkPolicies for **all** the subnets on the virtual network where the **private endpoints** will be created. See this [link](https://docs.microsoft.com/en-us/azure/private-link/disable-private-endpoint-network-policy) for details on how to enable the policies.
- Preparation & configuration of the virtual network and the subnet **dedicated** to the SQL managed instance. See this [link](https://docs.microsoft.com/en-us/azure/azure-sql/managed-instance/vnet-existing-add-subnet) for more information.
- On the subnet where the webapp/app service plan vNet integration will be created, subnet delegation to **Microsoft.Web/serverFarms** needs to be configured.

## Example *.tfvars file
The required values for values are described in the following example of a *tfvars file.
The variables mentioned in this example are **not** default and **must** be defined for the root module to run successfully.

```

#--[Naming module variable values]-------------------------------------------------------------------------------
azure_region      = "germanywestcentral"
organization_code = "sie"
environment_code  = "p"
subscription_code = "lnd1"

#backend_suffix used by the naming module for the backend resource groups
backend_suffix = ["backend"]

#shared_suffix used by the shared resource group naming
shared_suffix = ["shared"]

#afqp & websi suffixes used by resources
afqp_suffix  = ["afqp"]
websi_suffix = ["websi"]
#--[Data network variable values]---------------------------------------------------------------------------------
#Virtual network name & resourcegroup name to reference. (where the related subnets are configured)
vnet_name    = "tst-lnd1-t-vnet-spoke"
vnet_rsgname = "tst-lnd1-t-rsg-vnet-spoke"

#The subnet names where the private endpoints, vnet integration & managedsqlinstance networking will be configured.
data_subnet_name   = "datastorage-subnet"
msqli_subnet_name  = "sqldb-subnet"
app_subnet_name    = "webapp-subnet"
appsvc_subnet_name = "appsvcintegration-subnet"
appgw_subnet_name  = "appgw-subnet"

#--[Resource group module variable values]-------------------------------------------------------------------------
rsg_tags = {
  "CanNotDelete" = "true"
  "AtosManaged"  = "true"
  "Infraversion" = "1.0.1"
}
#--[Private DNS zone module variable values]------------------------------------------------------------------------
dns_tags = {
  "AtosManaged" = "true"
}
#--[Storage account module variable values]------------------------------------------------------------------------
sa_blob_delete_retention_policy      = 7
sa_container_delete_retention_policy = 7
//sa_ip_rules - change this value to the ip address which needs to approach the storage account from the azure portal.
sa_ip_rules       = ["xxx.xxx.xxx.xxx"]
sa_container_name = "democontainer001"
sa_share_name     = "demoshare001"
sa_share_quota    = 100
afqp_sa_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
websi_sa_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
#--[Redis Cache module variable values]----------------------------------------------------------------------------
redis_cache_family   = "C"
redis_cache_skuname  = "Standard"
redis_cache_capacity = 0
afqp_redis_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
websi_redis_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
#--[CosmosDB module variable values]-------------------------------------------------------------------------------
cosmosdb_dbname              = "sieshowcasedemodb001"
cosmosdb_collection_name     = "sieshowcasecoll001"
cosmosdb_interval_in_minutes = "60"
cosmosdb_retention_in_hours  = "8"
cosmosdb_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
#--[Managed SQL Instance module variable values]--------------------------------------------------------------------
msqli_administrator_login_password = "Sup3rSecur3P@ss!"
msqli_sku_name                     = "GP_Gen5"
msqli_storage_size_in_gb           = 704
msqli_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
#--[App Service plan module variable values]------------------------------------------------------------------------
appservice_service_plan = {
  kind             = "app"
  size             = "P1v2"
  tier             = "PremiumV2"
  per_site_scaling = true
}
appsvc_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}
#--[App Insights module variable values]----------------------------------------------------------------------------
#No values
#--[App service module variable values]----------------------------------------------------------------------------
appservice_site_config = {
  always_on                = true
  dotnet_framework_version = "v4.0"
  ftps_state               = "FtpsOnly"
  http2_enabled            = false
  min_tls_version          = "1.2"
  default_documents        = ["hostingstart.html"]

}
afqp_tags = {
  "AtosManaged" = "true"
  "Application" = "afqp"
}
websi_tags = {
  "AtosManaged" = "true"
  "Application" = "websi"
}
afqp_webapp_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = "value"
}
websi_webapp_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = "value"
}
#------------------------------------App Gateway variable values------------------------------------------
appgw_defaultpool                    = "appgw-afqp-backendpool"
appgw_frontend_ip_configuration_name = "feipconfig"

# appgw_private_ip_address  - this has to be provided from the application team, what ip address to use
appgw_private_ip_address = "xxx.xxx.xxx.xxx"

# appgw_ssl_certificate - this has to be provided from the application team.
appgw_ssl_certificate = {
  name     = "appgwtestapp-ssl-cert",
  data     = "./<certificate name>.pfx",
  password = "Password123"
}
appgw_backendpools = [
  {
    name         = "appgw-afqp-backendpool",
    fqdns        = ["tst-lnd1-t-appsvc-afqp.azurewebsites.net"],
    ip_addresses = null
  },
  {
    name         = "appgw-websi-backendpool",
    fqdns        = ["tst-lnd1-t-appsvc-websi.azurewebsites.net"],
    ip_addresses = null
  }
]
appgw_http_settings_name = "appgateway-httpsettings"
//appgw_path_rule - this has to be provided from the application team (what are the actual paths? is case sensitive).
appgw_path_rule = [
  {
    name                       = "childpathone",
    paths                      = ["/dummy1*"],
    backend_address_pool_name  = "appgw-afqp-backendpool",
    backend_http_settings_name = "appgateway-httpsettings"
  },
  {
    name                       = "childpathtwo",
    paths                      = ["/dummy2*"],
    backend_address_pool_name  = "appgw-websi-backendpool",
    backend_http_settings_name = "appgateway-httpsettings"
  }
]
appgw_routing_rule_name = "routingrule1"
appgw_url_path_map_name = "urlpathmap"
appgw_tags = {
  "AtosManaged"      = "true"
  "AtosMonitoringID" = ""
}


```

## Child modules arguments
In this section all the child modules and how they are being used in this root module are mentioned.
The relevant arguments for the child modules are specified. For a full list of all available variables, check the child module readme files and the variable.tf files.

### terraform-naming
| Name                | Type           | Required | Description                                                                                                                                                                                          |
| ------------------- | -------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `azure_region`      | `string`       | true     | The Azure location/region to which the resources are being deployed. This will be used to get the corresponding four character Atos code according to Atos DCS naming convention.                    |
| `organization-code` | `string`       | true     | A three character Atos code according to Atos DCS naming convention indicating which organization we are deploying this automation for. When for Atos use: ats                                       |
| `environment-code`  | `string`       | true     | A one character Atos code according to Atos DCS naming convention to indicate which environment type will be deployed to. Example 'd' for Development, 't' for Test etc.                             |
| `subscription-code` | `string`       | true     | A four character Atos code according to Atos DCS naming convention to indicate which subscription we are deploying the automation to. Example 'mgmt' for management, 'lnd1' for the 1st landingzone. |
| `suffix`            | `list(string)` | false    | Possible suffixes to add to the name being generated. Example 'showcase', 'afqp', 'backend'. No limits on number of characters.                                                                      |

### terraform-azurerm-resourcegroup
| Name       | Type          | Required | Description                                        |
| ---------- | ------------- | -------- | -------------------------------------------------- |
| `name`     | `object`      | true     | The resource group name.                           |
| `location` | `string`      | true     | The location of the resource group.                |
| `tags`     | `map(string)` | true     | A mapping of tags to assign to the resource group. |

### terraform-azurerm-privatedns

| Name                  | Type          | Required | Description                                        |
| --------------------- | ------------- | -------- | -------------------------------------------------- |
| `name`                | `object`      | true     | The name of the Private DNS Zone                           |
| `resource_group_name` | `string`      | true     | Specifies the resource group where the resource exists.     |
| `tags`                | `map(string)` | false    | A mapping of tags to assign to the resource group. |
| `private_dns_zone_vnet_link_name` | `string` | true    | The name of the Private DNS Zone Virtual Network Link. Changing this forces a new resource to be created.|
| `private_dns_zone_name`                | `string` | true    | The name of the Private DNS zone (without a terminating dot). |
| `virtual_network_id `                | `map(string)` | true    |The ID of the Virtual Network that should be linked to the DNS Zone. |

### terraform-azurerm-storageaccount
| Name                                | Type     | Required | Description                                                                                                                                             |
| ----------------------------------- | -------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`                              | `string` | true     | Specifies the name of the storage account.                                                                                                              |
| `resource_group_name `              | `string` | true     | The name of the resource group in which to create the storage account.                                                                                  |
| `location`                          | `string` | true     | Specifies the supported Azure location where the resource exists.                                                                                       |
| `account_kind`                      | `string` | true     | Defines the Kind of account. Valid options are BlobStorage, BlockBlobStorage, FileStorage, Storage and StorageV2.                                       |
| `account_tier`                      | `string` | true     | TDefines the Tier to use for this storage account. Valid options are Standard and Premium.                                                              |
| `account_replication_type`          | `string` | true     | Defines the type of replication to use for this storage account. Valid options are LRS, GRS, RAGRS, ZRS, GZRS and RAGZRS.                               |
| `access_tier`                       | `string` | true     | Defines the access tier for BlobStorage, FileStorage and StorageV2 accounts. Valid options are Hot and Cool.                                            |
| `allow_blob_public_access`          | `string` | false    | Boolean flag to allow or disallow public access to all blobs or containers in the storage account.                                                      |
| `shared_access_key_enabled`         | `string` | false    | Boolean flag which indicates whether the storage account permits requests to be authorized with the account access key via Shared Key.                  |
| `blob_delete_retention_policy `     | `string` | false    | Specifies the number of days that the blob should be retained in days.                                                                                  |
| `container_delete_retention_policy` | `string` | false    | Specifies the number of days that the container should be retained in days.                                                                             |
| `container_name`                    | `string` | true     | The name of the Container which should be created within the Storage Account.                                                                           |
| `container_access_type`             | `string` | true     | The Access Level configured for this Container. Possible values are blob, container or private. Defaults to private.                                    |
| `share_name`                        | `string` | true     | The name of the share. Must be unique within the storage account where the share is located.                                                            |
| `share_quota`                       | `string` | true     | The maximum size of the share, in gigabytes.                                                                                                            |
| `default_action`                    | `string` | true     | Specifies the default action of allow or deny when no other rules match. Valid options are Deny or Allow.                                               |
| `ip_rules`                          | `string` | false    | List of public IP or IP ranges in CIDR Format. Only IPV4 addresses are allowed. Private IP address ranges (as defined in RFC 1918) are not allowed.     |
| `bypass`                            | `string` | false    | Specifies whether traffic is bypassed for Logging/Metrics/AzureServices. Valid options are any combination of Logging, Metrics, AzureServices, or None. |
| `tags`                              | `map`    | false    | A mapping of tags to assign to the resource.                                                                                                            |

### terraform-azurerm-privateendpoint

| Name                              | Type     | Required | Description                                                                                                              |
| --------------------------------- | -------- | -------- | ------------------------------------------------------------------------------------------------------------------------ |
| `name`                            | `object` | true     | The name of the private endpoint connection.                                                                             |
| `location`                        | `string` | true     | The location of the private endpoint.                                                                                    |
| `resource_group_name`             | `string` | true     | Specifies the Name of the Resource Group within which the Private Endpoint should exist.                                 |
| `subnet_id`                       | `string` | true     | The ID of the Subnet from which Private IP Addresses will be allocated for this Private Endpoint.                        |
| `private_service_connection_name` | `string` | true     | Specifies the Name of the Private Service Connection.                                                                    |
| `private_connection_resource_id`  | `string` | true     | The ID of the Private Link Enabled Remote Resource which this Private Endpoint should be connected to.                   |
| `subresources_name `              | `string` | true     | A list of subresource names which the Private Endpoint is able to connect to. Subresource_names corresponds to group_id. |


### terraform-azurerm-rediscache
| Name                  | Type     | Required | Description                                                                                                                                                    |
| --------------------- | -------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`                | `string` | true     | The name of the Redis instance.                                                                                                                                |
| `resource_group_name` | `string` | true     | The name of the resource group in which to create the Redis instance.                                                                                          |
| `location`            | `string` | true     | The location of the resource group.                                                                                                                            |
| `capacity`            | `number` | true     | The size of the Redis cache to deploy. Valid values for a SKU family of C (Basic/Standard) are 0, 1, 2, 3, 4, 5, 6, and for P (Premium) family are 1, 2, 3, 4. |
| `family`              | `string` | true     | The SKU family/pricing group to use. Valid values are C (for Basic/Standard SKU family) and P (for Premium).                                                   |
| `sku_name`            | `string` | true     | The SKU of Redis to use. Possible values are Basic, Standard and Premium.                                                                                      |
| `tags`                | `map`    | false    | A mapping of tags to assign to the resource.                                                                                                                   |

### terraform-azurerm-cosmosdb
| Name                  | Type     | Required | Description                                                                                                                             |
| --------------------- | -------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| `cosmos_name`         | `string` | true     | Name of the CosmosDB account that will be deployed.                                                                                     |
| `resource_group_name` | `string` | true     | The name of the resource group in which to create the CosmosDB account.                                                                 |
| `location`            | `string` | true     | Resource Group location.                                                                                                                |
| `dbname`              | `string` | true     | Name of the Mongo database that will be deployed.                                                                                       |
| `collection_name`     | `string` | true     | Name of the Mongo collection                                                                                                            |
| `offer_type`          | `string` | true     | Specifies the Offer Type to use for this CosmosDB Account - currently this can only be set to Standard.                                 |
| `interval_in_minutes` | `string` | false    | The interval in minutes between two backups. This is configurable only when type is Periodic. Possible values are between 60 and 1440.  |
| `retention_in_hours`  | `string` | false    | The time in hours that each backup is retained. This is configurable only when type is Periodic. Possible values are between 8 and 720. |
| `default_ttl_seconds` | `number` | true     | The default Time To Live in seconds for collection                                                                                      |
| `shard_key`           | `string` | true     | The name of the key to partition on for sharding. There must not be any other unique index keys                                         |
| `tags`                | `map`    | false    | A mapping of tags to assign to the resource.                                                                                            |

### terraform-azurerm-managedsqlinstance
| Name                           | Type     | Required | Description                                                                                                   |
| ------------------------------ | -------- | -------- | ------------------------------------------------------------------------------------------------------------- |
| `name`                         | `string` | true     | The name of the SQL Managed Instance. This needs to be globally unique within Azure.                          |
| `resource_group_name`          | `string` | true     | The name of the resource group in which to create the SQL Server.                                             |
| `location`                     | `string` | true     | Specifies the supported Azure location where the resource exists.                                             |
| `subnet_id`                    | `string` | true     | The subnet resource id that the SQL Managed Instance will be associated with.                                 |
| `administrator_login_password` | `string` | true     | The password associated with the administrator_login user.                                                    |
| `sku_name`                     | `string` | true     | Specifies the SKU Name for the SQL Managed Instance. Valid values include GP_Gen4, GP_Gen5, BC_Gen4, BC_Gen5. |
| `collation`                    | `string` | false    | Specifies how the SQL Managed Instance will be collated. Default value is SQL_Latin1_General_CP1_CI_AS.       |
| `timezone_id`                  | `string` | false    | The TimeZone ID that the SQL Managed Instance will be operating in.                                           |
| `storage_size_in_gb`           | `number` | true     | Maximum storage space for your instance. It should be a multiple of 32GB.                                     |
| `tags`                         | `map`    | false    | A mapping of tags to assign to the resource.                                                                  |

### terraform-azurerm-appserviceplan

| Name                  | Type     | Required | Description                                                             |
| --------------------- | -------- | -------- | ----------------------------------------------------------------------- |
| `appsvcplan_name`     | `string` | true     | Specifies the name of the app service plan.                             |
| `resource_group_name` | `string` | true     | The name of the resource group in which to create the app service plan. |
| `location`            | `string` | true     | Specifies the supported Azure location where the resource exists.       |
| `service_plan`        | `map`    | true     | Defines the kind, size and tier for app service plan                    |
| `tags`                | `map`    | false    | A mapping of tags to assign to the resource.                            |

### terraform-azurerm-applicationinsight
| Name                        | Type     | Required |  Description |
| --------------------------- | -------- | -------- | ---------------- |
| `appinsights_name`          | `string` | true     | Specifies the name of the app Insights. |
| `resource_group_name`       | `string` | true     | The name of the resource group in which to create the app service plan. |
| `location`                  | `string` | true     | Specifies the supported Azure location where the resource exists. |
| `application_insights_type` | `string` | true     | Defines the type of application insights |
| `retention_in_days`         | `string` | true     | number of days for the logs to retained |
| `disable_ip_masking`        | `string` | false    | By default the real client ip is masked as 0.0.0.0 in the logs. Use this argument to disable masking and log the real client ip |
| `tags`                      | `map`    | false    | A mapping of tags to assign to the resource.|

### terraform-azurerm-appservice

| Name                       | Type     | Required | Description                                                             |
| -------------------------- | -------- | -------- | ----------------------------------------------------------------------- |
| `appservice_name `         | `string` | true     | Specifies the name of the app service plan.                             |
| `resource_group_name`      | `string` | true     | The name of the resource group in which to create the app service plan. |
| `location`                 | `string` | true     | Specifies the supported Azure location where the resource exists.       |
| `app_service_plan_id`      | `map`    | true     | Defines the kind, size and tier for app service plan                    |
| `tags`                     | `map`    | false    | A mapping of tags to assign to the resource.                            |
| `site_config`              | `map`    | true     | Defines various site configs                                            |
| `always_on`                | `bool`   | false    | Specifies whether always_on true or not.                                |
| `dotnet_framework_version` | `string` | false    | Specifies the dotnet_framework_version.                                 |
| `ftps_state`               | `string` | false    | Specifies the ftps state.                                               |
| `connection_strings`       | `map`    | false    | Defines various connection strings                                      |
| `name`                     | `string` | false    | Specifies name of the connection string.                                |
| `type`                     | `string` | false    | Specifies the type of connection ex: SQLAzure or SQLServer.             |
| `value`                    | `string` | false    | value of the connection string.                                         |
| `http2_enabled`            | `bool`   | false    | Specifies whether https is enabled or not.                              |
| `min_tls_version`          | `string` | false    | Specifies the minumum TLS version required.                             |
| `appservice_vnet_name`     | `string` | true     | vnet name that appservice going to integrate                            |
| `appsrevice_vnet_rsgname`  | `string` | true     | vnet resource group that app service going to integrate.                |
| `appservice_subnet_name`   | `string` | true     | subnet name that app service going to integrate.                        |

### terraform-azurerm-applicationgateway
| Name | Type | Required | Description |
| --- | --- | --- | --- |
| `appgw_name` | `string` | true | The name of this Application Gateway. |
| `appgw_rsg` | `string` | true | Resource Group this Application Gateway is deployed in. |
| `appgw_location` | `string` | true | Application Gateway location. |
| `enable_http2` | `bool` | true | HTTP2 enabled on the application gateway. Defaults to false. |
| `tags` | `map(string)` | true | Tag value. |
| `appgw_sku_size` | `string` | true | Application Gateway SKU size. Possible values: Standard_Small, Standard_Medium, Standard_Large, Standard_v2, WAF_Medium, WAF_Large, and WAF_v2. |
| `appgw_tier` | `string` | true | Application Gateway SKU tier. Possible values are Standard, Standard_v2, WAF and WAF_v2. |
| `appgw_capacity` | `number` | true | The Capacity of the SKU to use for this Application Gateway. When using a V1 SKU this value must be between 1 and 32. |
| `waf_enabled` | `bool` | true | WAF (Web Aplication Firewall) on Application Gateway. Defaults to true. |
| `waf_configuration` | `object({})` | true | WAF configuration. Block (Block1) is defined below. Please read for details. Defaults to null. |
| `vnet_name` | `string` | true | Virtual Network this Application Gateway is deployed in. |
| `subnet_name` | `string` | true | Subnet this Application Gateway is deployed in. |
| `vnet_rsg_name` | `string` | true | Virtual Network resource group name. |
| `frontend_ip_configuration_name` | `string` | true | he name of the Frontend IP Configuration. |
| `private_ip_address` | `string` | true | The Private IP Address to use for the Application Gateway. Pick one from the subnet this Application Gateway is deployed in. Static allocation. |
| `frontend_port_number` | `number` | true | Enter a frontend port number for the listener. You can use well known ports, such as port 80 and 443, or any port ranging from 1 to 65502 (v1 SKU). |
| `ssl_certificate` | `object({})` | true | SSL certficate configuration. Block (Block2) is defined below. Please read for details.|
| `probe` | `list(object({}))` | true | Probe configuration. Block (Block3) is defined below. Please read for details. |
| `backendpools` | `list(object({}))` | true | Backend Pools. Supply a name for the pool and a list of fqdn's/IP's which should be part of the backend address pool. Block (Block4) is defined below. Please read for details. |
| `http_listener_protocol` | `string` | true | The Protocol to use for HTTP Listener. Possible values are Http and Https. |
| `http_settings_name` | `string` | true | The name of the Backend HTTP Settings Collection - between 1 and 80 characters. Must begin with a letter or number, end with a letter, number or underscore, and may contain only letters, numbers, underscores, periods, or hyphens. |
| `cookie_based_affinity` | `string` | true | Http Settings: Is Cookie-Based Affinity enabled? Possible values are Enabled and Disabled. |
| `backend_port` | `number` | true | The port which should be used for this Backend HTTP Settings Collection. |
| `backend_protocol` | `string` | true | Http Settings: The Protocol which should be used. Possible values are Http and Https. |
| `request_timeout` | `number` | true | Http Settings: The request timeout is the number of seconds that the application gateway will wait to receive a response from the backend pool before it returns a “connection timed out” error message - between 1 and 86400 seconds. |
| `connection_draining` | `bool` | true | Http Settings: If connection draining is enabled or not. Defaults to false. |
| `drain_timeout` | `number` | true | Http Settings: The number of seconds connection draining is active. Acceptable values are from 1 second to 3600 seconds. Specify this value even if connection_draining is set to false. |
| `hostfrombackend` | `bool` | true | Http Settings: Pick host name from backend target. Defaults to true. |
| `custom_probe` | `string` | true | Http Settings: The name of an associated HTTP Probe. |
| `url_path_map_name` | `string` | true | The Name of the URL Path Map which should be associated with this Routing Rule. |
| `path_rule` | `list(object({}))` | true | Path based rules. Forms a part of URL path map. Block (Block5) is defined below. Please read for details. |
| `routing_rule_name` | `string` | true | The Name of this Request Routing Rule - between 1 and 80 characters. Must begin with a letter or number, end with a letter, number or underscore, and may contain only letters, numbers, underscores, periods, or hyphens. |
| `routing_rule_type` | `string` | true | The Type of Routing that should be used for this Rule. Possible values are Basic and PathBasedRouting. |
| `defaultpool` | `string` | true |  Default pool name to be used in Request Routing Rule.|


#### Block1 - waf_configuration
| Name | Type | Required | Description |
| --- | --- | --- | --- |
| `firewall_mode` | `string` | true | The Web Application Firewall Mode. Possible values are Detection and Prevention. |
| `rule_set_type` | `string` | true | The Type of the Rule Set used for this Web Application Firewall. Currently, only OWASP is supported. |
| `rule_set_version` | `string` | true | The Version of the Rule Set used for this Web Application Firewall. Possible values are 2.2.9, 3.0, and 3.1. |
| `file_upload_limit_mb` | `string` | true | The File Upload Limit in MB. Accepted values are in the range 1MB to 750MB for the WAF_v2 SKU, and 1MB to 500MB for all other SKUs. Defaults to 100MB. |
| `max_request_body_size_kb` | `string` | true | The Maximum Request Body Size in KB. Accepted values are in the range 1KB to 128KB. Defaults to 128KB. |

```
Note: this block defaults to NULL, which leads to the following configuration for WAF. Unless you want to change this configuration, please let the default value stay as null.

firewall_mode            = "Detection"
rule_set_type            = "OWASP"
rule_set_version         = "3.0"
file_upload_limit_mb     = 100
max_request_body_size_kb = 128

Example:
default = null

```
#### Block2 - ssl_certificate
Since decision has been made to use v1 gateway SKU, keyvault can't be used.
TLS termination with Key Vault certificates is limited to the v2 SKUs.
Copy the certificate into the repo. Provide that path in 'data'.

| Name | Type | Required | Description |
| --- | --- | --- | --- |
| `name` | `string` | true | The Name of the SSL certificate that is unique within this Application Gateway |
| `data` | `string` | true | PFX certificate. |
| `password` | `string` | true | Password for the pfx file specified in data. |

```
Example:
default = {
    name     = "appgw-ssl-cert",
    data     = "./mycert.com.pfx",
    password = "Password123"
  }
```
#### Block3 - probe
Note: You may use the values as is from the example provided below, with name of your choice. Connection to app service in the backend (https).

| Name | Type | Required | Description |
| --- | --- | --- | --- |
| `name` | `string` | true | The Name of the Probe. |
| `protocol` | `string` | true | The Protocol used for this Probe. Possible values are Http and Https. |
| `interval` | `number` | true | The Interval between two consecutive probes in seconds. Possible values range from 1 second to a maximum of 86,400 seconds. |
| `timeout` | `number` | true | The Timeout used for this Probe, which indicates when a probe becomes unhealthy. Possible values range from 1 second to a maximum of 86,400 seconds. |
| `unhealthy_threshold` | `number` | true | The Unhealthy Threshold for this Probe, which indicates the amount of retries which should be attempted before a node is deemed unhealthy. Possible values are from 1 - 20 seconds. |
| `pick_host_name_from_backend_http_settings` | `bool` | true | Whether the host header should be picked from the backend http settings. |
| `host` | `string` | true | The Hostname used for this Probe. If the Application Gateway is configured for a single site, by default the Host name should be specified as ‘127.0.0.1’, unless otherwise configured in custom probe. *Cannot be set if pick_host_name_from_backend_http_settings is set to true. Use value NULL* |
| `path` | `string` | true | The Path used for this Probe. |


```
Example:
default = [
    {
      name                                      = "probe1",
      protocol                                  = "https",
      interval                                  = 30,
      timeout                                   = 30,
      unhealthy_threshold                       = 3,
      pick_host_name_from_backend_http_settings = true,
      host                                      = null
      path                                      = "/"
    }
  ]
```

#### Block4 - backendpools
| Name | Type | Required | Description |
| --- | --- | --- | --- |
| `name` | `string` | true | The name of the Backend Address Pool. |
| `fqdns` | `list(string)` | true | A list of FQDN's which should be part of the Backend Address Pool. |
| `ip_addresses` | `list(string)` | true | A list of IP Addresses which should be part of the Backend Address Pool. |

```
Example:
  default = [
    {
      name         = "appgw-backendpool1",
      fqdns        = ["app1.azurewebsites.net"],
      ip_addresses = null
    },
    {
      name         = "appgw-backendpool2",
      fqdns        = ["app2.azurewebsites.net"],
      ip_addresses = null
    }
  ]
```

#### Block5 - path_rule
| Name | Type | Required | Description |
| --- | --- | --- | --- |
| `name` | `string` | true | The Name of the Path Rule. |
| `paths` | `list(string)` | true | A list of Paths used in this Path Rule. |
| `backend_address_pool_name` | `string` | true | The Name of the Backend Address Pool to use for this Path Rule. |
| `backend_http_settings_name` | `string` | true | The Name of the Backend HTTP Settings Collection to use for this Path Rule. |

```
Example:
  default = [
    {
      name                       = "pathone",
      paths                      = ["/pathone*"],
      backend_address_pool_name  = "appgw-backendpool1",
      backend_http_settings_name = "appgateway-httpsettings"
    },
    {
      name                       = "pathtwo",
      paths                      = ["/pathtwo*"],
      backend_address_pool_name  = "appgw-backendpool2",
      backend_http_settings_name = "appgateway-httpsettings"
    }
  ]

Note- paths are case sensitive.
```